-- Create codelist tables

                    CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_1_recent_asthma_code AS
                    SELECT code, '8A091FAD8B889D7C55B6007F8D3F364318C3661F6F6CBF77AC9C9E9898C2E36B' AS hashed_organisation FROM (
                      VALUES (734904007), (185737001), (390798007), (527231000000108), (370225008), (370221004), (93432008), (423889005), (185732007), (170631002), (390921001), (170642006), (312453004), (370226009), (201191000000108), (281239006), (370203002), (708038006), (370208006), (201211000000107), (170636007), (201031000000108), (390878008), (715191006), (390940007), (445531003), (708096008), (12428000), (270442000), (527171000000103), (771901000000100), (405944004), (233678006), (401182001), (10692761000119107), (711442001), (170634005), (708093000), (195949008), (225057002), (406162001), (340891000000106), (928511000000107), (170655007), (370206005), (11641008), (370202007), (373899003), (340931000000101), (866881000000101), (201201000000105), (312454005), (185734008), (448003001), (302331000000106), (811151000000105), (401193004), (304527002), (708095007), (233688007), (340921000000103), (527191000000104), (1086701000000102), (302220000), (308501009), (185728001), (401135008), (308500005), (340901000000107), (708358003), (233687002), (170632009), (170657004), (424643009), (183478001), (401183006), (201051000000101), (233691007), (233679003), (867171000000106), (390872009), (170656008), (195967001), (734346005), (370204008), (815631000000106), (811921000000103), (389145006), (772051000000106), (445074007), (771941000000102), (370219009), (170633004), (201041000000104), (170647000), (182731009), (170638008), (370205009), (185735009), (966011000000109), (185730004), (182727003), (394720003), (699191007), (527211000000100), (370218001), (185736005), (185731000), (698509001), (195977004), (182730005), (63088003), (708090002), (708094006), (443117005), (928451000000107), (400987003), (41553006), (170635006), (233683003), (473391009), (1086711000000100), (185940009), (170637003), (57607007), (34015007), (275908000), (959421000000105), (443450003), (395022009), (734905008), (772011000000107), (31387002), (959401000000101), (182724005), (370207001), (366874008), (394701000), (448002006), (161527007), (810901000000102), (394700004), (407674008), (390877003), (818161000000104), (771981000000105), (736056000), (182726007), (959441000000103), (170658009), (266361008), (405720007), (182728008), (370220003), (754061000000100), (340911000000109), (708373002), (182729000), (1751000119100), (707444001), (404808000), (404804003), (125001000119103), (425969006), (10675391000119101), (445427006), (10675551000119104), (427295004), (735587000), (30352005), (418395004), (59786004), (10675751000119107), (18041002), (404806001), (707980005), (233672007), (10675991000119100), (762521001), (10675871000119106), (442025000), (10676511000119109), (10742121000119104), (72301000119103), (735589002), (232430006), (427603009), (401000119107), (125021000119107), (10676391000119108), (99031000119107), (707979007), (125011000119100), (707512002), (13151001), (426656000), (1103911000000103), (424199006), (85761009), (92807009), (707513007), (699728000), (703954005), (1741000119102), (707446004), (707447008), (427679007), (55570000), (19849005), (10674711000119105), (10676431000119103), (10675431000119106), (703953004), (707445000), (10675911000119109), (733858005), (56968009), (135171000119106), (10675471000119109), (2360001000004109), (426979002), (409663006), (89099002), (124991000119109), (10692681000119108), (429258006), (16584951000119101), (135181000119109), (735588005), (707981009), (10692721000119102), (707511009), (944971000000100), (512181000000107), (389146007), (307580006), (165621000000103), (170641004), (233682008), (1065181000000104), (503311000000108), (527181000000101), (778591000000109), (56507008), (959411000000104), (778621000000107), (67415000), (266364000), (57546000), (134380003), (189521000000104), (527221000000106), (771951000000104), (370210008), (302341000000102), (233685005), (778551000000101), (512201000000106), (959451000000100), (593601000000101), (427354000), (772091000000103), (503301000000106), (811931000000101), (521381000000109), (791171000000104), (416601004), (778541000000104), (512191000000109), (832091000000103), (233686006), (966021000000103), (512241000000109), (1064811000000103), (1064771000000103), (778601000000103), (202571000000105), (778531000000108), (948091000000109), (302351000000104), (791181000000102), (527241000000104), (948101000000101), (233681001), (503321000000102), (186081000000101), (589231000000108), (772101000000106), (653751000000109), (928521000000101), (512211000000108), (771991000000107), (778571000000105), (778581000000107), (170654006), (579691000000102), (186071000000103), (778561000000103), (928461000000105), (503331000000100), (189511000000105), (644281000000107), (412775002), (91340006), (959431000000107), (811161000000108), (771911000000103), (754071000000107), (233689004), (944961000000107), (1945002), (866891000000104), (772021000000101), (778611000000101), (59327009), (772061000000109), (1761000119103), (778521000000106), (512231000000100), (593201000000103), (689421000000104), (527201000000102), (1064821000000109), (418122003)
                    ) AS t (code)
                    ;



                    CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_2_asthma_code_ever AS
                    SELECT code, '8A091FAD8B889D7C55B6007F8D3F364318C3661F6F6CBF77AC9C9E9898C2E36B' AS hashed_organisation FROM (
                      VALUES (734904007), (185737001), (390798007), (527231000000108), (370225008), (370221004), (93432008), (423889005), (185732007), (170631002), (390921001), (170642006), (312453004), (370226009), (201191000000108), (281239006), (370203002), (708038006), (370208006), (201211000000107), (170636007), (201031000000108), (390878008), (715191006), (390940007), (445531003), (708096008), (12428000), (270442000), (527171000000103), (771901000000100), (405944004), (233678006), (401182001), (10692761000119107), (711442001), (170634005), (708093000), (195949008), (225057002), (406162001), (340891000000106), (928511000000107), (170655007), (370206005), (11641008), (370202007), (373899003), (340931000000101), (866881000000101), (201201000000105), (312454005), (185734008), (448003001), (302331000000106), (811151000000105), (401193004), (304527002), (708095007), (233688007), (340921000000103), (527191000000104), (1086701000000102), (302220000), (308501009), (185728001), (401135008), (308500005), (340901000000107), (708358003), (233687002), (170632009), (170657004), (424643009), (183478001), (401183006), (201051000000101), (233691007), (233679003), (867171000000106), (390872009), (170656008), (195967001), (734346005), (370204008), (815631000000106), (811921000000103), (389145006), (772051000000106), (445074007), (771941000000102), (370219009), (170633004), (201041000000104), (170647000), (182731009), (170638008), (370205009), (185735009), (966011000000109), (185730004), (182727003), (394720003), (699191007), (527211000000100), (370218001), (185736005), (185731000), (698509001), (195977004), (182730005), (63088003), (708090002), (708094006), (443117005), (928451000000107), (400987003), (41553006), (170635006), (233683003), (473391009), (1086711000000100), (185940009), (170637003), (57607007), (34015007), (275908000), (959421000000105), (443450003), (395022009), (734905008), (772011000000107), (31387002), (959401000000101), (182724005), (370207001), (366874008), (394701000), (448002006), (161527007), (810901000000102), (394700004), (407674008), (390877003), (818161000000104), (771981000000105), (736056000), (182726007), (959441000000103), (170658009), (266361008), (405720007), (182728008), (370220003), (754061000000100), (340911000000109), (708373002), (182729000), (1751000119100), (707444001), (404808000), (404804003), (125001000119103), (425969006), (10675391000119101), (445427006), (10675551000119104), (427295004), (735587000), (30352005), (418395004), (59786004), (10675751000119107), (18041002), (404806001), (707980005), (233672007), (10675991000119100), (762521001), (10675871000119106), (442025000), (10676511000119109), (10742121000119104), (72301000119103), (735589002), (232430006), (427603009), (401000119107), (125021000119107), (10676391000119108), (99031000119107), (707979007), (125011000119100), (707512002), (13151001), (426656000), (1103911000000103), (424199006), (85761009), (92807009), (707513007), (699728000), (703954005), (1741000119102), (707446004), (707447008), (427679007), (55570000), (19849005), (10674711000119105), (10676431000119103), (10675431000119106), (703953004), (707445000), (10675911000119109), (733858005), (56968009), (135171000119106), (10675471000119109), (2360001000004109), (426979002), (409663006), (89099002), (124991000119109), (10692681000119108), (429258006), (16584951000119101), (135181000119109), (735588005), (707981009), (10692721000119102), (707511009), (944971000000100), (512181000000107), (389146007), (307580006), (165621000000103), (170641004), (233682008), (1065181000000104), (503311000000108), (527181000000101), (778591000000109), (56507008), (959411000000104), (778621000000107), (67415000), (266364000), (57546000), (134380003), (189521000000104), (527221000000106), (771951000000104), (370210008), (302341000000102), (233685005), (778551000000101), (512201000000106), (959451000000100), (593601000000101), (427354000), (772091000000103), (503301000000106), (811931000000101), (521381000000109), (791171000000104), (416601004), (778541000000104), (512191000000109), (832091000000103), (233686006), (966021000000103), (512241000000109), (1064811000000103), (1064771000000103), (778601000000103), (202571000000105), (778531000000108), (948091000000109), (302351000000104), (791181000000102), (527241000000104), (948101000000101), (233681001), (503321000000102), (186081000000101), (589231000000108), (772101000000106), (653751000000109), (928521000000101), (512211000000108), (771991000000107), (778571000000105), (778581000000107), (170654006), (579691000000102), (186071000000103), (778561000000103), (928461000000105), (503331000000100), (189511000000105), (644281000000107), (412775002), (91340006), (959431000000107), (811161000000108), (771911000000103), (754071000000107), (233689004), (944961000000107), (1945002), (866891000000104), (772021000000101), (778611000000101), (59327009), (772061000000109), (1761000119103), (778521000000106), (512231000000100), (593201000000103), (689421000000104), (527201000000102), (1064821000000109), (418122003)
                    ) AS t (code)
                    ;



                    CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_3_copd_code_ever AS
                    SELECT code, '8A091FAD8B889D7C55B6007F8D3F364318C3661F6F6CBF77AC9C9E9898C2E36B' AS hashed_organisation FROM (
                      VALUES (7457009), (16003001), (267276009), (233754007), (196190001), (233703007), (196001008), (213223003), (233664005), (473202005), (526091000000100), (196052005), (361195001), (50589003), (515631000000107), (233757000), (716358000), (87433001), (266366003), (47386001), (233696002), (195957006), (233695003), (86406008), (88039007), (81423003), (233667003), (827571000000106), (68328006), (111292008), (42402006), (427123006), (196047000), (77690003), (810951000000101), (233697006), (859041000000103), (16838000), (233733000), (12295008), (196027008), (85761009), (170628003), (233692000), (26427008), (19274004), (232660006), (848431000000106), (236302005), (10785007), (24369008), (205237003), (401184000), (196137000), (48347002), (195953005), (360470001), (233738009), (232657004), (162974009), (44165003), (49691004), (394702007), (66987001), (16623004), (10692761000119107), (51577008), (68333005), (13394002), (196046009), (8549006), (196053000), (37471005), (8247009), (73144008), (361194002), (723245007), (716281000000103), (115666004), (90610005), (7343008), (313297008), (69339004), (196049002), (23022004), (390891009), (196021009), (390941006), (736283006), (713731000000102), (233665006), (394703002), (196136009), (233748006), (36696005), (86555001), (367542003), (233728004), (233755008), (77593006), (185086009), (105977003), (87909002), (67569000), (233758005), (233764003), (71193007), (17996008), (196125002), (293991000000106), (371611000000107), (233753001), (233726000), (711379004), (414087000), (233774000), (276537001), (190905008), (195959009), (266368002), (428173007), (398726004), (190909002), (10713006), (277656005), (375911000000102), (700250006), (233701009), (233761006), (233698001), (716311000000100), (12088005), (233630006), (86092005), (195963002), (44549008), (196135008), (233713004), (155597006), (427022004), (445090007), (56968009), (857791000000103), (233629001), (1066231000000103), (89549007), (40100001), (51615001), (196026004), (46847001), (233724002), (195984007), (84004001), (7548000), (7063008), (232659001), (195951007), (233627004), (84409004), (404807005), (198401000000104), (33325001), (47895001), (85438006), (50076003), (233771008), (313296004), (1066821000000101), (266355005), (40527005), (233628009), (45145000), (266356006), (44274007), (233725001), (233751004), (718241000000107), (196138005), (232658009), (235978006), (277485007), (266404004), (857811000000102), (438773007), (40122008), (86638007), (195989002), (233762004), (847091000000104), (78723001), (18121009), (63480004), (195958001), (233759002), (313299006), (783631000000109), (811961000000106), (383611000000102), (233727009), (13151001), (233763009), (599006), (25897000), (18690003), (48188009), (717021000000106), (29422001), (196051003), (61233003), (413845009), (719218000), (233673002), (79958002), (22607003), (120639003), (897311000000101), (61937009), (195985008), (408501008), (195990006), (233699009), (790301000000101), (196028003), (277486008), (285381006), (17385007), (789661000000102), (52333004), (233750003), (426896000), (939431000000108), (857661000000104), (80825009), (20322005), (13645005), (233631005), (1259003), (716241000000106), (233700005), (716901000000101), (760601000000107), (187233002), (233632003), (233770009), (760621000000103), (233663004), (233615002), (129451001), (704121003), (58691003), (198411000000102), (1066851000000106), (52571006), (196019004), (4981000), (233730002), (90117007), (233749003), (233767005), (741056003), (233666007), (892321000000109), (233672007), (74417001), (233674008), (826111000000109), (14700006), (73448002), (86204009), (805261000000101), (805002), (275503004), (49158009), (67242002), (233756009), (776981000000103), (717521000000104), (375851000000108), (49840000), (51277007), (429332008), (233702002), (270473001), (233659006), (820341000000109), (233675009), (866901000000103), (233694004), (1066281000000104), (135836000), (90623003), (196017002), (401185004), (233633008), (85407005), (233661002), (62371005), (233677001), (74015002), (38729007), (42680007), (233634002), (715069001), (233769008), (196133001), (39871006), (398640008), (426705001), (233772001), (704123000), (1066841000000108), (233768000), (64631008), (526071000000104), (425748003), (47515009), (198901000000105), (23315001), (192658007), (233715006), (37711000), (707435002), (409665004), (84753008), (40218008), (38534008), (7678002), (319841000119107), (425996009), (737183007), (3487004), (266350000), (240629003), (233610007), (64936001), (19325002), (86680006), (154283005), (200050006), (91947003), (10625671000119106), (75426006), (415125002), (28791000119105), (64880000), (707553005), (308906005), (713341001), (713967004), (68409003), (713718006), (10625351000119105), (713544008), (425464007), (81000119104), (713734009), (31920006), (186204008), (713489006), (713446007), (1087061000119106), (57463004), (76090006), (735525005), (46207001), (707433009), (707552000), (45556008), (713504001), (125295001), (196033004), (713570009), (10625551000119103), (7361000175106), (301003007), (10625511000119104), (762269004), (45312009), (52079000), (442094008), (233717003), (700252003), (64917006), (233691007), (707507003), (735527002), (102361000119104), (471272001), (713881001), (240103002), (416916004), (106001000119101), (181007), (124691000119101), (230180003), (1082721000119101), (206283000), (713732008), (708031000), (196035006), (90691000119105), (713506004), (277844007), (90681000119107), (277869007), (12571000132104), (716088000), (186193001), (425558002), (142931000119100), (35037009), (72621000119104), (713733003), (186195008), (11211003), (80614003), (186203002), (186708007), (398329009), (314978007), (713511002), (763888005), (713444005), (720401009), (735528007), (12310001), (80191000119101), (700249006), (233617005), (63607006), (187052004), (123591006), (66110007), (762271004), (736056000), (12381000132107), (2912004), (396285007), (397763006), (195911009), (195902009), (233613009), (70036007), (26511004), (1751000119100), (735524009), (713546005), (66429007), (301000005), (707551007), (59475000), (735466008), (233624006), (86649001), (720469008), (700251005), (713543002), (64479007), (81164001), (59773008), (707449006), (713320007), (33548005), (85469005), (200049006), (129452008), (713318009), (206286008), (714464009), (713349004), (713964006), (230598008), (64030005), (16846004), (737180005), (38976008), (427046006), (186175002), (713275003), (47082005), (233607000), (762194005), (733051000), (713084008), (195878008), (722913002), (441942006), (408680002), (50804000), (32204007), (713508003), (713880000), (713340000), (430969000), (53084003), (233625007), (213152006), (11944003), (22754005), (301004001), (713297001), (408681003), (196032009), (446946005), (206289001), (195900001), (704345008), (10625111000119106), (713531003), (31898008), (31561003), (713530002), (80602006), (87153008), (186194007), (41207000), (41997000), (713316008), (78895009), (724498004), (240391001), (88687001), (713887002), (10624991000119103), (72656004), (10625631000119108), (123590007), (233716007), (111900000), (57702005), (62479008), (713488003), (713300006), (123588006), (278484009), (699014000), (441590008), (714083007), (430395005), (198014000), (19076009), (195888009), (28295001), (713484001), (707766007), (735526006), (713729005), (35031000119100), (708026002), (713844000), (67525007), (737184001), (713325002), (276695003), (233623000), (48794007), (64667001), (713571008), (396286008), (733835007), (721095007), (195889001), (707373004), (10625231000119106), (714203003), (28122003), (240871004), (65141002), (58890000), (713545009), (708030004), (32544004), (233760007), (300999006), (240387006), (371072008), (733834006), (44547005), (38699009), (64703005), (89099002), (10625831000119107), (713505000), (10613001), (721166000), (416491000), (421508002), (123589003), (240741002), (735522008), (713497004), (421047005), (708537005), (10625271000119109), (716198008), (51530003), (722912007), (943041000000105), (713897006), (32139003), (713525001), (765275003), (51068008), (441658007), (83457000), (10625591000119108), (713299003), (276692000), (59940009), (128711000119106), (22343003), (233609002), (233619008), (18354001), (724500003), (13217005), (724499007), (196040003), (195908008), (713523008), (233620002), (429271009), (79019005), (10625311000119109), (1240551000000105), (240635003), (71926009), (420544002), (233604007), (40786001), (10625471000119108), (195881003), (405569006), (430476004), (10625391000119100), (366971000119100), (421671002), (233606009), (91948008), (60485005), (735523003), (12181002), (200051005), (408679000), (278516003), (196153002), (713533000), (55679008), (713278001), (125294002), (426437004), (32286006), (407671000), (422588002), (186177005), (733453005), (80003002), (233714005), (415126001), (52500008), (35339003), (195896004), (10746341000119109), (697923008), (427670006), (409664000), (86263001), (713510001), (236807008), (206284006), (233621003), (276693005), (195909000), (301001009), (1033111000000104), (70756004), (186707002), (10625431000119105), (233608005), (196037003), (17569003), (737182002), (704120002), (737181009), (725415009), (427445002), (385093006), (233731003), (10625151000119107), (196112005), (235009000), (39172002), (233618000), (713695001), (442025000), (713572001), (191727003), (428697002), (196115007), (81554001), (713845004), (60805002), (72270005), (301002002), (276665006), (713490002), (713260006), (195886008), (420787001), (86294001), (41381004), (41269000), (10625751000119106), (1092361000119109), (83271005), (87117006), (42004004), (195904005), (713339002), (1092951000119106), (713527009), (366981000119102), (34004002), (713722001), (713532005), (719522009), (445096001), (302913000), (143111000119103), (10625031000119102), (196151000), (438764004), (16311000119108), (196034005), (707508008), (67782005), (240742009), (10692721000119102), (236793007), (235726002), (10625711000119105), (328661000119108), (40780007), (196116008), (200052003), (23958009), (713731001), (40640008), (233614003), (713487008), (34020007), (266370006), (762270003), (233622005), (713445006), (123587001), (713503007), (187196002), (312342009), (15708009), (10625071000119104), (735465007), (426696003), (71727007), (72854003), (722557007), (447006007), (61884008), (713696000), (57686001), (111880001), (725052002), (236406007), (713526000), (735521001), (713507008), (713298006), (713491003), (186706006), (83608006), (10625191000119102), (47938003), (713342008), (425793006), (206285007), (713730000), (417688002), (46970008), (2523007), (89687005), (427121008), (206287004), (426853005), (75570004), (713483007), (405631006), (707503004), (293241000119100), (401000119107), (10672271000119100), (315019000), (95892003), (445378003), (240747003), (196152007), (627021000000105), (444811000000101), (412891000000108), (186718002), (255641000000102), (294011000000104), (944971000000100), (811971000000104), (57716000), (604421000000104), (789761000000107), (456391000000106), (230201009), (255631000000106), (186709004), (948121000000105), (186717007), (413311000000103), (451271000000107), (429381000000103), (645421000000106), (60837001), (654461000000102), (240311002), (84350008), (312403005), (832441000000100), (129458007), (649131000000101), (414341000000100), (207321000000104), (276694004), (187061004), (707001000000100), (649171000000104), (617941000000107), (113071000000105), (414701000000104), (174211000000102), (644271000000105), (807891000000100), (169651000000106), (375921000000108), (823151000000103), (686551000000103), (19285002), (848441000000102), (88693009), (375861000000106), (207331000000102), (428061000000103), (948111000000104), (60690004), (554071000000106), (412776001), (383621000000108), (526101000000108), (807851000000108), (174231000000105), (827581000000108), (233693005), (790311000000104), (401941000000104), (689401000000108), (186719005), (442341000000102), (113061000000103), (515641000000103), (375871000000104), (89991000000102), (186725009), (636501000000107), (1054001000000101), (391131001), (781651000000101), (820351000000107), (312602005), (456031000000108), (526111000000105), (186723002), (528511000000103), (414882007), (468671000000107), (17365008), (5810003), (550501000000102), (441141000000108), (213411000000108), (169631000000104), (422052002), (325371000000107), (196038008), (626081000000109), (187450003), (413321000000109), (45719002), (432461000000108), (455571000000106), (397981000000105), (111885006), (706991000000106), (31886003), (568721000000106), (111282000), (83316006), (174221000000108), (338121000000103), (670641000000109), (253151000000106), (187451004), (359787005), (915671000000101), (187042003), (396284006), (554081000000108), (897321000000107), (339601000000108), (281390005), (38118004), (250521000000103), (240611008), (823141000000101), (781661000000103), (707021000000109), (122971000000108), (555141000000100), (1033141000000103), (15341009), (192671000000106), (826121000000103), (564611000000104), (807871000000104), (123620007), (454431000000109), (419331000000108), (20197001), (186191004), (169641000000108), (656891000000102), (255621000000109), (1053901000000104), (420245002), (439901000000106), (187445009), (857671000000106), (33615004), (807391000000107), (466811000000104), (397991000000107), (421977001), (195882005), (196161007), (810721000000108), (649201000000103), (658391000000105), (789671000000109), (1033121000000105), (325401000000109), (432411000000106), (611551000000109), (579661000000108), (402915006), (89706008), (113041000000104), (389075004), (1033131000000107), (81638006), (84234002), (586341000000100), (45157009), (57541005), (781711000000106), (36154007), (422241000), (213421000000102), (368861000000109), (338241000000100), (418661000000104), (78466009), (645401000000102), (409081000000107), (866911000000101), (427069009), (523671000000103), (338131000000101), (204574007), (187453001), (783641000000100), (192681000000108), (62246005), (649151000000108), (196009005), (707891000000102), (890871000000103), (80440003), (441561000000104), (169761000000104), (57086000), (468931000000102), (421189000), (419441000000105), (47839005), (390151000000103), (195905006), (760611000000109), (469801000000105), (526211000000102), (601611000000106), (16810008), (401191000000107), (807861000000106), (579421000000102), (74455006), (411831000000102), (478351000000102), (421979003), (831811000000105), (939441000000104), (213401000000106), (442351000000104), (292571000000107), (60696005), (421792005), (409811000000108), (718251000000105), (832111000000108), (54962007), (564621000000105), (213431000000100), (422031005), (412775002), (42964004), (89087009), (91923005), (113051000000101), (413846005), (778131000000103), (471471000000106), (37721008), (626071000000107), (807651000000109), (579411000000108), (226461000000108), (375931000000105), (419861000000108), (523661000000105), (286451000000100), (400631000000109), (421218006), (535011000000101), (540141000000105), (233689004), (540151000000108), (46933004), (586721000000108), (789751000000109), (413621000000104), (859051000000100), (195738009), (944961000000107), (652331000000107), (487261000000103), (427921000000108), (313433007), (621061000000108), (857801000000104), (649141000000105), (491091000000105), (601591000000103), (760631000000101), (64912000), (77070006), (390971000000109), (28168000), (566801000000107), (834861000000109), (685151000000101), (781591000000108), (397190009), (400401000000101), (68759006), (187438009), (834851000000106), (421154002), (630531000000104), (420749009), (834491000000101), (564541000000102), (812311000000102), (233723008), (186726005), (195920000), (1761000119103), (294001000000101), (422260007), (616161000000107), (421835000), (113031000000108), (204572006), (123592004), (312261006), (420991002), (432151000000100), (186721000), (50648007), (21072009), (707011000000103), (389077007), (41659003), (267513007), (28944009), (233795005), (65710008), (66489009), (78048006), (47382004), (264569006), (427928003), (63764008), (174802006), (33286000), (123946008), (62907002), (427089005), (700273003), (32413006), (88415009), (64572001), (417152008), (16140007), (186464008), (32477003), (363346000), (363225006), (253745002), (40733004)
                    ) AS t (code)
                    ;



                    CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_4_prednisolone_last_year AS
                    SELECT code, '8A091FAD8B889D7C55B6007F8D3F364318C3661F6F6CBF77AC9C9E9898C2E36B' AS hashed_organisation FROM (
                      VALUES (52911000001107), (238511000001107), (646211000001106), (649711000001109), (707911000001100), (798611000001108), (844111000001103), (9807711000001108), (10409611000001103), (14786411000001103), (15175511000001102), (18285011000001109), (21851211000001107), (30114811000001104), (30858911000001100), (32807911000001101), (32772911000001108), (32776111000001109), (85511000001101), (86711000001103), (110811000001100), (350611000001104), (772111000001107), (876911000001107), (940311000001100), (9807911000001105), (10410111000001103), (14786811000001101), (18285211000001104), (18625211000001107), (21851411000001106), (30115011000001109), (30859111000001105), (32808311000001101), (380011000001100), (685311000001104), (779211000001109), (858811000001104), (4208511000001105), (15175711000001107), (17916411000001100), (17999311000001104), (18307011000001109), (19743011000001109), (22452711000001102), (30114011000001105), (36568211000001107), (37130211000001109), (255211000001101), (447211000001105), (512811000001108), (662011000001105), (4208911000001103), (15176111000001100), (17916811000001103), (17999611000001109), (18307211000001104), (19743211000001104), (22453011000001108), (30114311000001108), (34444511000001106), (37130611000001106), (313911000001107), (716111000001103), (4852811000001108), (17917211000001102), (30991311000001108), (37131011000001108), (37778711000001106), (32584711000001105), (33425811000001105), (33428411000001103), (37130011000001104), (37778311000001107), (32773211000001105), (32776511000001100), (13055311000001107), (13055911000001108), (13120111000001109), (13120411000001104), (13054411000001101), (13054711000001107), (13056211000001105), (13056511000001108), (13058011000001101), (13058311000001103), (157711000001100), (157711000001100), (245011000001108), (245011000001108), (392511000001108), (392511000001108), (15172311000001102), (15172311000001102), (28937511000001104), (28937511000001104), (30114611000001103), (30114611000001103), (34035411000001102), (34035411000001102), (34172711000001106), (34172711000001106), (13056811000001106), (13057411000001106), (32771211000001106), (32776311000001106), (29361211000001105), (29559211000001100), (32688311000001106), (29879111000001105), (30129111000001103), (37778511000001101), (37941611000001100), (32774411000001107), (32776711000001105), (459611000001100), (331111000001100), (22519711000001105), (22520311000001107), (28798211000001102), (28799011000001102), (28799311000001104), (28799611000001109), (28799811000001108), (32652311000001103), (32652511000001109), (33577911000001102), (325426006), (28808611000001100), (325427002), (325442004), (325443009), (325450008), (32611811000001105), (28808711000001109), (416533002), (432225008), (432224007), (13133111000001100), (429995001), (13078611000001106), (13078911000001100), (13079011000001109), (13079311000001107), (13079411000001100), (325444003), (325444003), (13079111000001105), (13079211000001104), (28808411000001103), (29424511000001109), (29904211000001102), (32781411000001102)
                    ) AS t (code)
                    ;


-- -- Query for icu_date_admitted
-- CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_icu_date_admitted AS
--             SELECT
--               registration_id AS patient_id,
--               hashed_organisation,

--         MIN(
--         CASE
--         WHEN
--           COALESCE(date_format(icuadmissiondatetime, '%Y-%m-%d'), '9999-01-01') < COALESCE(date_format(originalicuadmissiondate, '%Y-%m-%d'), '9999-01-01')
--         THEN
--           DATE(icuadmissiondatetime)
--         ELSE
--           DATE(originalicuadmissiondate)
--         END) AS first_admitted_date,
--               MAX(Ventilator) AS ventilated -- apparently can be 0, 1 or NULL
--             FROM
--               icnarc_view
--             GROUP BY registration_id, hashed_organisation
--             HAVING

--         MIN(
--         CASE
--         WHEN
--           COALESCE(date_format(icuadmissiondatetime, '%Y-%m-%d'), '9999-01-01') < COALESCE(date_format(originalicuadmissiondate, '%Y-%m-%d'), '9999-01-01')
--         THEN
--           DATE(icuadmissiondatetime)
--         ELSE
--           DATE(originalicuadmissiondate)
--         END) >= DATE('2020-02-01') AND SUM(basicdays_respiratorysupport) + SUM(advanceddays_respiratorysupport) >= 1
--             ;


-- Query for died_date_cpns
-- CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_died_date_cpns AS
--             SELECT
--               registration_id as patient_id,
--               hashed_organisation,
--               MAX(dateofdeath) AS date_of_death,
--               -- Crude error check so we blow up in the case of inconsistent dates
--               1 / CASE WHEN MAX(dateofdeath) = MIN(dateofdeath) THEN 1 ELSE 0 END AS _e
--             FROM cpns_view
--             WHERE dateofdeath <= DATE('2020-06-01')
--             GROUP BY registration_id, hashed_organisation
--             ;


-- Query for died_ons_covid_flag_any
-- CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_died_ons_covid_flag_any AS
--             SELECT
--                 registration_id as patient_id,
--                 hashed_organisation,
--                 1 AS died
--             FROM ons_view
--             WHERE (icd10u IN ('U071','U072') OR icd10001 IN ('U071','U072') OR icd10002 IN ('U071','U072') OR icd10003 IN ('U071','U072') OR icd10004 IN ('U071','U072') OR icd10005 IN ('U071','U072') OR icd10006 IN ('U071','U072') OR icd10007 IN ('U071','U072') OR icd10008 IN ('U071','U072') OR icd10009 IN ('U071','U072') OR icd10010 IN ('U071','U072') OR icd10011 IN ('U071','U072') OR icd10012 IN ('U071','U072') OR icd10013 IN ('U071','U072') OR icd10014 IN ('U071','U072') OR icd10015 IN ('U071','U072')) AND dod <= DATE('2020-06-01')
--             ;


-- -- Query for died_ons_covid_flag_underlying
-- CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_died_ons_covid_flag_underlying AS
--             SELECT
--                 registration_id as patient_id,
--                 hashed_organisation,
--                 1 AS died
--             FROM ons_view
--             WHERE (icd10u IN ('U071','U072')) AND dod <= DATE('2020-06-01')
--             ;


-- -- Query for died_date_ons
-- CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_died_date_ons AS
--             SELECT
--                 registration_id as patient_id,
--                 hashed_organisation,
--                 dod AS date_of_death
--             FROM ons_view
--             WHERE (1 = 1) AND dod <= DATE('2020-06-01')
--             ;


-- Query for age
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_age AS
            SELECT
              registration_id AS patient_id,
              hashed_organisation,
              CASE WHEN
                 date_add('year', date_diff('year', date_of_birth, DATE('2020-02-01')), date_of_birth) > DATE('2020-02-01')
              THEN
                 date_diff('year', date_of_birth, DATE('2020-02-01')) - 1
              ELSE
                 date_diff('year', date_of_birth, DATE('2020-02-01'))
              END AS age
            FROM patient_view
            ;


-- Query for sex
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_sex AS
          SELECT
            registration_id AS patient_id,
            hashed_organisation,
            CASE gender
              -- See https://www.datadictionary.nhs.uk/data_dictionary/attributes/p/person/person_gender_code_de.asp?shownav=1
              WHEN 1 THEN 'M'
              WHEN 2 THEN 'F'
              ELSE ''
            END AS sex
          FROM patient_view;


-- Query for imd
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_imd AS
            SELECT
              registration_id AS patient_id,
              hashed_organisation,
              imd_rank AS index_of_multiple_deprivation
            FROM
              patient_view
            ;


-- Query for rural_urban
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_rural_urban AS
            SELECT
              registration_id AS patient_id,
              hashed_organisation,
              rural_urban AS rural_urban_classification
            FROM
              patient_view
            ;


-- Query for stp
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_stp AS
            SELECT
              registration_id AS patient_id,
              hashed_organisation,
              stp_code AS stp_code
            FROM
              patient_view
            ;


-- Query for region
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_region AS
            SELECT
              registration_id AS patient_id,
              hashed_organisation,
              english_region_name AS nuts1_region_name
            FROM
              patient_view
            ;


-- Query for bmi
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_bmi AS
        SELECT
          patients.registration_id AS patient_id,
          hashed_organisation,
          CASE
            WHEN height = 0 THEN NULL
            ELSE ROUND(COALESCE(weight/(height*height), bmis.BMI), 1)
          END AS BMI,
          CASE
            WHEN weight IS NULL OR height IS NULL THEN DATE(bmis.effective_date)
            ELSE DATE(weights.effective_date)
          END AS date
        FROM (
           SELECT registration_id, hashed_organisation, date_of_birth
           FROM patient_view
        ) AS patients
        LEFT JOIN (
          SELECT t.registration_id, t.weight, t.effective_date
          FROM (
            SELECT registration_id, "value_pq_1" AS weight, effective_date,
            ROW_NUMBER() OVER (PARTITION BY registration_id ORDER BY effective_date DESC) AS rownum
            FROM observation_view
            WHERE snomed_concept_id IN (27113001,162763007) AND effective_date >= DATE('2010-02-01')
          ) t
          WHERE t.rownum = 1
        ) AS weights
        ON weights.registration_id = patients.registration_id AND date_diff('year', patients.date_of_birth, weights.effective_date) >= 16
        LEFT JOIN (
          SELECT t.registration_id, t.height, t.effective_date
          FROM (
            SELECT registration_id, "value_pq_1" AS height, effective_date,
            ROW_NUMBER() OVER (PARTITION BY registration_id ORDER BY effective_date DESC) AS rownum
            FROM observation_view
            WHERE snomed_concept_id IN (271603002,162755006) AND 1=1
          ) t
          WHERE t.rownum = 1
        ) AS heights
        ON heights.registration_id = patients.registration_id AND date_diff('year', patients.date_of_birth, heights.effective_date) >= 16
        LEFT JOIN (
        SELECT t.registration_id, t.BMI, t.effective_date
        FROM (
          SELECT registration_id, "value_pq_1" AS BMI, effective_date,
          ROW_NUMBER() OVER (PARTITION BY registration_id ORDER BY effective_date DESC) AS rownum
          FROM observation_view
          WHERE snomed_concept_id = 301331008 AND effective_date >= DATE('2010-02-01')
        ) t
        WHERE t.rownum = 1
        ) AS bmis
        ON bmis.registration_id = patients.registration_id AND date_diff('year', patients.date_of_birth, bmis.effective_date) >= 16
        -- XXX maybe add a "WHERE NULL..." here
        ;


-- Query for recent_asthma_code
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_recent_asthma_code AS
            SELECT
              registration_id AS patient_id,
              observation_view.hashed_organisation,
              1 AS has_event,
              MAX(DATE(effective_date)) AS date
            FROM observation_view
            INNER JOIN _TABLE_PREFIX_1_recent_asthma_code
            ON snomed_concept_id = _TABLE_PREFIX_1_recent_asthma_code.code
            WHERE effective_date BETWEEN DATE('2017-02-01') AND DATE('2020-02-01') AND 1 = 1
            GROUP BY registration_id, observation_view.hashed_organisation
            ;


-- Query for asthma_code_ever
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_asthma_code_ever AS
            SELECT
              registration_id AS patient_id,
              observation_view.hashed_organisation,
              1 AS has_event,
              MAX(DATE(effective_date)) AS date
            FROM observation_view
            INNER JOIN _TABLE_PREFIX_2_asthma_code_ever
            ON snomed_concept_id = _TABLE_PREFIX_2_asthma_code_ever.code
            WHERE 1=1 AND 1 = 1
            GROUP BY registration_id, observation_view.hashed_organisation
            ;


-- Query for copd_code_ever
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_copd_code_ever AS
            SELECT
              registration_id AS patient_id,
              observation_view.hashed_organisation,
              1 AS has_event,
              MAX(DATE(effective_date)) AS date
            FROM observation_view
            INNER JOIN _TABLE_PREFIX_3_copd_code_ever
            ON snomed_concept_id = _TABLE_PREFIX_3_copd_code_ever.code
            WHERE 1=1 AND 1 = 1
            GROUP BY registration_id, observation_view.hashed_organisation
            ;


-- Query for prednisolone_last_year
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_prednisolone_last_year AS
            SELECT
              registration_id AS patient_id,
              medication_view.hashed_organisation,
              COUNT(*) AS count,
              MAX(DATE(effective_date)) AS date
            FROM medication_view
            INNER JOIN _TABLE_PREFIX_4_prednisolone_last_year
            ON snomed_concept_id = _TABLE_PREFIX_4_prednisolone_last_year.code
            WHERE effective_date BETWEEN DATE('2019-02-01') AND DATE('2020-02-01') AND 1 = 1
            GROUP BY registration_id, medication_view.hashed_organisation
            ;


-- Query for bp_sys
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_bp_sys AS
        SELECT
          days.registration_id AS patient_id,
          days.hashed_organisation,
          AVG(observation_view."value_pq_1") AS mean_value,
          days.date_measured AS date
        FROM (
            SELECT
                registration_id,
                hashed_organisation,
                CAST(MAX(effective_date) AS date) AS date_measured
            FROM observation_view
            WHERE snomed_concept_id IN (163030003) AND effective_date <= DATE('2020-02-01')
            GROUP BY registration_id, hashed_organisation
        ) AS days
        LEFT JOIN observation_view
        ON (
          observation_view.registration_id = days.registration_id
          AND observation_view.snomed_concept_id IN (163030003)
          AND CAST(observation_view.effective_date AS date) = days.date_measured
        )
        GROUP BY days.registration_id, days.hashed_organisation, days.date_measured
        ;


-- Query for bp_dias
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_bp_dias AS
        SELECT
          days.registration_id AS patient_id,
          days.hashed_organisation,
          AVG(observation_view."value_pq_1") AS mean_value,
          days.date_measured AS date
        FROM (
            SELECT
                registration_id,
                hashed_organisation,
                CAST(MAX(effective_date) AS date) AS date_measured
            FROM observation_view
            WHERE snomed_concept_id IN (163031004) AND effective_date <= DATE('2020-02-01')
            GROUP BY registration_id, hashed_organisation
        ) AS days
        LEFT JOIN observation_view
        ON (
          observation_view.registration_id = days.registration_id
          AND observation_view.snomed_concept_id IN (163031004)
          AND CAST(observation_view.effective_date AS date) = days.date_measured
        )
        GROUP BY days.registration_id, days.hashed_organisation, days.date_measured
        ;


-- Query for population
CREATE TABLE IF NOT EXISTS _TABLE_PREFIX_population AS
            SELECT
                patient_view.registration_id AS patient_id,
                hashed_organisation,
                1 AS is_registered
            FROM patient_view
            WHERE registered_date <= DATE('2019-02-01')
              AND (registration_end_date > DATE('2020-02-01') OR registration_end_date IS NULL)
            ;


-- Query for final_output

        SELECT
          _TABLE_PREFIX_population.patient_id AS patient_id,
          -- COALESCE(date_format(_TABLE_PREFIX_icu_date_admitted.first_admitted_date, '%Y-%m-%d'), '') AS icu_date_admitted,
          -- COALESCE(date_format(_TABLE_PREFIX_died_date_cpns.date_of_death, '%Y-%m-%d'), '') AS died_date_cpns,
          -- COALESCE(_TABLE_PREFIX_died_ons_covid_flag_any.died, 0) AS died_ons_covid_flag_any,
          -- COALESCE(_TABLE_PREFIX_died_ons_covid_flag_underlying.died, 0) AS died_ons_covid_flag_underlying,
          -- COALESCE(date_format(_TABLE_PREFIX_died_date_ons.date_of_death, '%Y-%m-%d'), '') AS died_date_ons,
          COALESCE(_TABLE_PREFIX_age.age, 0) AS age,
          COALESCE(_TABLE_PREFIX_sex.sex, '') AS sex,
          COALESCE(_TABLE_PREFIX_imd.index_of_multiple_deprivation, 0) AS imd,
          COALESCE(_TABLE_PREFIX_rural_urban.rural_urban_classification, 0) AS rural_urban,
          COALESCE(_TABLE_PREFIX_stp.stp_code, '') AS stp,
          COALESCE(_TABLE_PREFIX_region.nuts1_region_name, '') AS region,
          COALESCE(_TABLE_PREFIX_bmi.BMI, 0.0) AS bmi,
          COALESCE(date_format(_TABLE_PREFIX_bmi.date, '%Y-%m'), '') AS bmi_date_measured,
          CASE WHEN (( ( COALESCE(_TABLE_PREFIX_recent_asthma_code.has_event, 0) != 0 ) OR ( ( COALESCE(_TABLE_PREFIX_asthma_code_ever.has_event, 0) != 0 ) AND NOT ( COALESCE(_TABLE_PREFIX_copd_code_ever.has_event, 0) != 0 ) ) ) AND ( COALESCE(_TABLE_PREFIX_prednisolone_last_year.count, 0) = 0 OR COALESCE(_TABLE_PREFIX_prednisolone_last_year.count, 0) > 4 )) THEN '1' WHEN (( ( COALESCE(_TABLE_PREFIX_recent_asthma_code.has_event, 0) != 0 ) OR ( ( COALESCE(_TABLE_PREFIX_asthma_code_ever.has_event, 0) != 0 ) AND NOT ( COALESCE(_TABLE_PREFIX_copd_code_ever.has_event, 0) != 0 ) ) ) AND COALESCE(_TABLE_PREFIX_prednisolone_last_year.count, 0) > 0 AND COALESCE(_TABLE_PREFIX_prednisolone_last_year.count, 0) < 5) THEN '2' ELSE '0' END AS asthma,
          COALESCE(_TABLE_PREFIX_bp_sys.mean_value, 0.0) AS bp_sys,
          COALESCE(date_format(_TABLE_PREFIX_bp_sys.date, '%Y-%m'), '') AS bp_sys_date_measured,
          COALESCE(_TABLE_PREFIX_bp_dias.mean_value, 0.0) AS bp_dias,
          COALESCE(date_format(_TABLE_PREFIX_bp_dias.date, '%Y-%m'), '') AS bp_dias_date_measured,
          _TABLE_PREFIX_population.hashed_organisation
        FROM
          _TABLE_PREFIX_population
          -- LEFT JOIN _TABLE_PREFIX_icu_date_admitted ON _TABLE_PREFIX_icu_date_admitted.patient_id = _TABLE_PREFIX_population.patient_id
          -- LEFT JOIN _TABLE_PREFIX_died_date_cpns ON _TABLE_PREFIX_died_date_cpns.patient_id = _TABLE_PREFIX_population.patient_id
          -- LEFT JOIN _TABLE_PREFIX_died_ons_covid_flag_any ON _TABLE_PREFIX_died_ons_covid_flag_any.patient_id = _TABLE_PREFIX_population.patient_id
          -- LEFT JOIN _TABLE_PREFIX_died_ons_covid_flag_underlying ON _TABLE_PREFIX_died_ons_covid_flag_underlying.patient_id = _TABLE_PREFIX_population.patient_id
          -- LEFT JOIN _TABLE_PREFIX_died_date_ons ON _TABLE_PREFIX_died_date_ons.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_age ON _TABLE_PREFIX_age.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_sex ON _TABLE_PREFIX_sex.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_imd ON _TABLE_PREFIX_imd.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_rural_urban ON _TABLE_PREFIX_rural_urban.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_stp ON _TABLE_PREFIX_stp.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_region ON _TABLE_PREFIX_region.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_bmi ON _TABLE_PREFIX_bmi.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_recent_asthma_code ON _TABLE_PREFIX_recent_asthma_code.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_asthma_code_ever ON _TABLE_PREFIX_asthma_code_ever.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_copd_code_ever ON _TABLE_PREFIX_copd_code_ever.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_prednisolone_last_year ON _TABLE_PREFIX_prednisolone_last_year.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_bp_sys ON _TABLE_PREFIX_bp_sys.patient_id = _TABLE_PREFIX_population.patient_id
          LEFT JOIN _TABLE_PREFIX_bp_dias ON _TABLE_PREFIX_bp_dias.patient_id = _TABLE_PREFIX_population.patient_id
        WHERE COALESCE(_TABLE_PREFIX_population.is_registered, 0) = 1
        ;


